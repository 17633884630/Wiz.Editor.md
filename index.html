<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
    "http://www.w3.org/TR/html4/loose.dtd">
<html lang="zh" style="height:100%;">
    <head>
        <meta charset="utf-8" />
        <title></title>
        <link rel="stylesheet" href="Editor.md/examples/css/style.css" />
        <link rel="stylesheet" href="Editor.md/css/editormd.css" />
    </head>
    <body style="height:100%;">
        <div id="layout" style="height:100%;">
            <div id="test-editormd">
                <textarea style="display:none;"></textarea>
            </div>
        </div>
        <script src="Editor.md/examples/js/jquery.min.js"></script>
        <script src="Editor.md/editormd.js"></script>
        <script type="text/javascript">
            var modified = false;		// 文档修改标志
			var saveLocalImg = true;	// 保存本地图片
            var objApp = window.external;
            var wizEditor;

            $(function() {
                var objCommon = null;
                try {
                    objCommon = objApp.CreateWizObject("WizKMControls.WizCommonUI");
                }
                catch (err) {
                }

                ////////////////////////////////////////////////
                // Load document
                function getQueryString(name) {
                    if (location.href.indexOf("?") == -1 || location.href.indexOf(name + '=') == -1) {
                        return '';
                    }
                    var queryString = location.href.substring(location.href.indexOf("?") + 1);

                    var parameters = queryString.split("&");

                    var pos, paraName, paraValue;
                    for (var i = 0; i < parameters.length; i++) {
                        pos = parameters[i].indexOf('=');
                        if (pos == -1) { continue; }

                        paraName = parameters[i].substring(0, pos);
                        paraValue = parameters[i].substring(pos + 1);

                        if (paraName == name) {
                            return unescape(paraValue.replace(/\+/g, " "));
                        }
                    }
                    return '';
                };

                var guid = getQueryString("guid");
                var kbGUID = getQueryString("kbguid");

                var objDatabase = null;
                if (kbGUID == "" || kbGUID == null) {
                    objDatabase = objApp.Database;
                }
                else {
                    objDatabase = objApp.GetGroupDatabase(kbGUID);
                }

                var objDocument = null;
                try {
                    objDocument = objDatabase.DocumentFromGUID(guid);
                    document.title = "编辑 " + objDocument.Title.replace(new RegExp(".md", "gi"), "");
                }
                catch (err) {
                }

				var imgTempPath = "../../temp/" + guid + "_4_files";
				var imgRealPath = guid + "_4_files";
                ////////////////////////////////////////////////
                // Extract Markdown text from HTML
                var code = "";
                if (objDocument) {
                    code = objDocument.GetText(0);
                    code = code.replace(/\u00a0/g, ' ');
					if (saveLocalImg) {
						code = code.replace(new RegExp(imgRealPath, "g"), imgTempPath);
					}
                }

                ////////////////////////////////////////////////
                // 配置编辑器功能
                wizEditor = editormd("test-editormd", {
                    theme           : "default",         // 主题样式，见editormd.themes定义
                    value           : code,
                    path            : "Editor.md/lib/",
                    htmlDecode      : "style,script,iframe",  // 开启HTML标签解析，为了安全性，默认不开启
                    codeFold        : true,              // 代码折叠，默认关闭
                    tex             : true,              // 开启科学公式TeX语言支持，默认关闭
                    flowChart       : true,              // 开启流程图支持，默认关闭
                    sequenceDiagram : true,              // 开启时序/序列图支持，默认关闭
                    toc             : true,              // [TOC]自动生成目录，默认开启
                    tocm            : false,             // [TOCM]自动生成下拉菜单的目录，默认关闭
                    tocTitle        : "",                // 下拉菜单的目录的标题
                    tocDropdown     : false,             // [TOC]自动生成下拉菜单的目录，默认关闭
                    emoji           : false,             // Emoji表情，默认关闭
                    taskList        : false,             // Task lists，默认关闭
                    disabledKeyMaps : [
                        "F9", "F10", "F11"               // 禁用切换全屏状态，因为为知已经支持
                    ],
                    toolbarIcons : function() {
                        var arrayIcons = ["saveIcon", "|"];
                        arrayIcons = arrayIcons.concat(editormd.toolbarModes["full"]);
                        arrayIcons.splice($.inArray("emoji", arrayIcons), 1);       // Emoji表情关闭时移除按钮
                        arrayIcons.splice($.inArray("fullscreen", arrayIcons), 1);  // 禁用切换全屏状态时移除按钮
                        return arrayIcons;
                    },
                    toolbarIconsClass : {
                        saveIcon : "fa-floppy-o"  // 指定一个FontAawsome的图标类
                    },
                    toolbarHandlers : {
                        saveIcon : function() {
                            saveDocument();
                        }
                    },
                    lang : {
                        toolbar : {
                            saveIcon : "保存 (Ctrl+S)"
                        }
                    },
                    onload : function() {
                        var keyMap = {
                            "Ctrl-F9": function(cm) {
                                $.proxy(wizEditor.toolbarHandlers["watch"], wizEditor)();
                            },
                            "Ctrl-F10": function(cm) {
                                $.proxy(wizEditor.toolbarHandlers["preview"], wizEditor)();
                            }
                        };
                        this.addKeyMap(keyMap);
                    },
                    onchange : function() {
                        modified = true;
                    },
                    onimageUploadButton : function() {
                        var filename = objCommon.SelectWindowsFile(true, "Image Files(*.png;*.jpg;*.gif;*.bmp)|*.png;*.jpg;*.gif;*.bmp|");
                        return filename;
                    }
                });

                ////////////////////////////////////////////////
                // 保存文档
                saveDocument = function () {
					saveDocumentEx();
					modified = false;
                };

				////////////////////////////////////////////////
                // 保存文档里面的图片到数据文件
                saveDocumentEx = function () {
					var docOrg = wizEditor.getValue();
					var doc = docOrg.replace(/\n|\r|(\r\n)|(\u0085)|(\u2028)|(\u2029)/g, "<br/>").replace(/ /g, '\u00a0');
					if (!saveLocalImg) {
						if (objDocument) {
							objDocument.UpdateDocument3(doc, 0);
						}
						return;
					}

					// 提取图片链接
					var linkExp = /!?\[((?:\[[^\]]*\]|[^\[\]]|\](?=[^\[]*\]))*)\]\(\s*<?([\s\S]*?)>?(?:\s+['"]([\s\S]*?)['"])?\s*\)/g;
					var arrCap = new Array();
					var cap = null;
					var imgStr = "";
					while (cap = linkExp.exec(docOrg)) {
                        // 如果是超链接，则再检索一遍
                        while (cap[0].charAt(0) !== "!") {
                            if ((cap = new RegExp(linkExp.source).exec(cap[1])) == null) {
                                break;
                            }
                        }
                        if (cap == null) {
                            continue;
                        };

						// 只提取本地图片的链接
						if (cap[2].indexOf("https://") != 0 && cap[2].indexOf("http://") != 0) {
							arrCap.push(cap);
							imgStr += "<img src=\"" + cap[2] + "\">";
						}
					}

					// 转换成隐藏标签
					var imgStrDiv = "<div name=\"markdownimage\" style=\"display:none;\">";
					if (imgStr.length > 0) {
						imgStr = imgStrDiv + imgStr + "</div>";
                        console.log(imgStr);
						showWaitDialog();
					}
					doc += imgStr;

					if (objDocument) {
						doc = doc.replace(new RegExp(imgTempPath, "g"), imgRealPath);
						objDocument.UpdateDocument3(doc, 0);

						if (imgStr.length == 0) {
							return;
						}

						code = objDocument.GetHtml();
						var imgStrDivStart = code.indexOf(imgStrDiv);
						if (imgStrDivStart != -1) {
							var imgStrDivEnd = code.indexOf("</div>", imgStrDivStart);
							if (imgStrDivEnd != -1) {
								var codeSub = code.substring(imgStrDivStart, imgStrDivEnd);

								var imgExp = /img src="(.*?)"/g;
								var curIdx = 0;
								var docNew = "";
								var docIdx = 0;
								while (cap = imgExp.exec(codeSub)) {
									if (curIdx >= arrCap.length) {
										break;
									}

									var curCap = arrCap[curIdx++];
									docNew += docOrg.substring(docIdx, curCap.index);
									docNew += curCap[0].replace(curCap[2], cap[1].replace("index_files", imgTempPath));
									docIdx = curCap.index + curCap[0].length;
								}
								docNew += docOrg.substring(docIdx);
								var hasWatch = wizEditor.settings.watch;
								wizEditor.setValue(docNew);
                                // 因为会触发change事件，所以这里强制设置改动标志
                                setTimeout(function () {
                                    modified = false;
                                }, wizEditor.settings.delay);

								// 再次保存更新后的文档
								doc = docNew.replace(/\n|\r|(\r\n)|(\u0085)|(\u2028)|(\u2029)/g, "<br/>").replace(/ /g, '\u00a0');
								// 隐藏标签也要保存，不然会被丢弃掉
								doc += imgStr;
								doc = doc.replace(new RegExp(imgTempPath, "g"), imgRealPath);
								objDocument.UpdateDocument3(doc, 0);
							}
						}
					}
					hideWaitDialog();
                };

				////////////////////////////////////////////////
                // 参照关于对话框写成的等待对话框
				createWaitDialog = function() {
					var editor       = wizEditor.editor;
					var classPrefix  = wizEditor.classPrefix;

					var waitDialogHTML = [
						"<div class=\"" + classPrefix + "dialog " + classPrefix + "dialog-info\" style=\"width:250px;\">",
						"<div class=\"" + classPrefix + "dialog-container\">",
						"<p>正在保存...</p><p>&nbsp;</p>",
						"<div class=\"" + classPrefix + "container-mask\" style=\"display:block;top: 50px;height:30%;\"></div>",
						"</div>",
						"</div>"
					].join("\n");

					editor.append(waitDialogHTML);

					var waitDialog  = wizEditor.waitDialog = editor.children("." + classPrefix + "dialog-info");

					waitDialog.css("border", (editormd.isIE8) ? "1px solid #ddd" : "").css("z-index", editormd.dialogZindex).show();

					waitDialogPosition();

					return wizEditor;
				},

				waitDialogPosition = function() {
					var waitDialog = wizEditor.waitDialog;

					var _waitDialogPosition = function() {
						waitDialog.css({
							top  : ($(window).height() - waitDialog.height()) / 2 + "px",
							left : ($(window).width()  - waitDialog.width()) / 2  + "px"
						});
					};

					_waitDialogPosition();

					$(window).resize(_waitDialogPosition);

					return wizEditor;
				},

				showWaitDialog = function() {
					$("html,body").css("overflow-x", "hidden");

					var editor      = wizEditor.editor;
					var settings    = wizEditor.settings;
					var waitDialog  = wizEditor.waitDialog = editor.children("." + wizEditor.classPrefix + "dialog-info");

					if (waitDialog.length < 1)
					{
						createWaitDialog();
					}

					wizEditor.lockScreen(true);

					wizEditor.mask.css({
								opacity         : settings.dialogMaskOpacity,
								backgroundColor : settings.dialogMaskBgColor
							}).show();

					waitDialog.css("z-index", editormd.dialogZindex).show();

					waitDialogPosition();

					return wizEditor;
				};

				hideWaitDialog = function() {
					$("html,body").css("overflow-x", "");
					wizEditor.waitDialog.hide();
					wizEditor.mask.hide();
					wizEditor.lockScreen(false);

					return wizEditor;
				};
            });

            ////////////////////////////////////////////////
            // 预防页面被跳转丢失编辑
            window.onbeforeunload = function () {
                if (modified) {
                    if (6 == objApp.Window.ShowMessage("是否保存？", "Wiz", 0x04 + 0x20)) {
                        saveDocument();
                    }
                }
            };

			////////////////////////////////////////////////
			// 为知回调
			// 关闭标签时会调用来判断是否需要保存
			function OnPluginQueryModified() {
				return modified;
			};

			////////////////////////////////////////////////
			// 为知回调
			// 可响应Ctrl+S保存事件
			function OnPluginSave() {
				saveDocument();
				return true;
			};
        </script>
    </body>
</html>
